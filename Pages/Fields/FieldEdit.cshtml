@page "{tableId:int}/{id:int?}"
@model EavWebApp.Pages.Fields.FieldEditModel
@{
    ViewData["Title"] = "Редактировать поля таблицы";
}

<h1>Поля таблицы: @Model.Table.Name</h1>

<p>
    <a asp-page="/Tables/TableEdit" asp-route-id="@Model.Table.Id" class="btn btn-secondary">Назад к таблице</a>
</p>

@if (Model.NewField.Id > 0)
{
    <h2>Редактировать поле</h2>
    <form method="post" asp-page-handler="EditField">
        <input type="hidden" asp-for="NewField.Id" />
        <input type="hidden" id="selectedTableId" name="selectedTableId" value="" />

        <div class="mb-2">
            <label>Название поля</label>
            <input type="text" asp-for="NewField.Name" class="form-control" required />
        </div>

        <div class="mb-2">
            <label>Тип поля</label>
            <select asp-for="NewField.FieldType" class="form-control" id="fieldTypeSelect">
                <option value="string">string</option>
                <option value="int">int</option>
                <option value="decimal">decimal</option>
                <option value="bool">bool</option>
                <option value="datetime">datetime</option>
                <option value="image">image</option>
                <option value="key">key</option>
            </select>
        </div>

        <!-- Настройки ключа -->
        <div class="mb-2" id="keySettingsSection" style="display: none;">
            <label>Связанная таблица</label>
            <select id="tableSelect" class="form-control">
                <option value="">Выберите таблицу...</option>
                @foreach (var table in Model.AllTables)
                {
                    <option value="@table.Id">@table.Name</option>
                }
            </select>

            <div id="fieldSelectContainer" style="margin-top: 10px; display: none;">
                <label>Поле для отображения</label>
                <select asp-for="NewField.IdKey" class="form-control" id="fieldSelect">
                    <option value="">Сначала выберите таблицу</option>
                </select>
            </div>
        </div>

        <button type="submit" class="btn btn-primary">Сохранить</button>
        <a asp-page="FieldEdit" asp-route-tableId="@Model.Table.Id" class="btn btn-secondary">Отмена</a>
    </form>
}
else
{
    <h2>Добавить новое поле</h2>
    <form method="post" asp-page-handler="AddField">
        <input type="hidden" id="selectedTableId" name="selectedTableId" value="" />

        <div class="mb-2">
            <label>Название поля</label>
            <input type="text" asp-for="NewField.Name" class="form-control" required />
        </div>

        <div class="mb-2">
            <label>Тип поля</label>
            <select asp-for="NewField.FieldType" class="form-control" id="fieldTypeSelect">
                <option value="string">string</option>
                <option value="int">int</option>
                <option value="decimal">decimal</option>
                <option value="bool">bool</option>
                <option value="datetime">datetime</option>
                <option value="image">image</option>
                <option value="key">key</option>
            </select>
        </div>

        <!-- Настройки ключа -->
        <div class="mb-2" id="keySettingsSection" style="display: none;">
            <label>Связанная таблица</label>
            <select id="tableSelect" class="form-control">
                <option value="">Выберите таблицу...</option>
                @foreach (var table in Model.AllTables)
                {
                    <option value="@table.Id">@table.Name</option>
                }
            </select>

            <div id="fieldSelectContainer" style="margin-top: 10px; display: none;">
                <label>Поле для отображения</label>
                <select asp-for="NewField.IdKey" class="form-control" id="fieldSelect">
                    <option value="">Сначала выберите таблицу</option>
                </select>
            </div>
        </div>

        <button type="submit" class="btn btn-primary">Добавить</button>
    </form>
}

<hr />

<h2>Существующие поля</h2>
@if (Model.Fields != null && Model.Fields.Any())
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Название</th>
                <th>Тип</th>
                <th>Связь</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var field in Model.Fields)
            {
                <tr>
                    <td>@field.Name</td>
                    <td>
                        @if (field.FieldType == "image")
                        {
                            <span>image </span>
                        }
                        else
                        {
                            @field.FieldType
                        }
                    </td>
                    <td>
                        @if (field.FieldType == "key" && field.IdKey.HasValue)
                        {
                            var relatedTable = Model.AllTables.FirstOrDefault(t => t.Fields.Any(f => f.Id == field.IdKey));
                            var displayField = relatedTable?.Fields.FirstOrDefault(f => f.Id == field.IdKey);
                            <text>@relatedTable?.Name → @displayField?.Name</text>
                        }
                        else
                        {
                            <text>-</text>
                        }
                    </td>
                    <td>
                        <a asp-page="FieldEdit" asp-route-tableId="@Model.Table.Id" asp-route-id="@field.Id" class="btn btn-sm btn-secondary">Изменить</a>
                        <a asp-page-handler="DeleteField" asp-route-id="@field.Id" class="btn btn-sm btn-danger" onclick="return confirm('Удалить поле?')">Удалить</a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <p>Поля отсутствуют.</p>
}

@section Scripts {
    <script>
        const typeSelect = document.getElementById('fieldTypeSelect');
        const keySection = document.getElementById('keySettingsSection');
        const tableSelect = document.getElementById('tableSelect');
        const fieldSelect = document.getElementById('fieldSelect');
        const fieldContainer = document.getElementById('fieldSelectContainer');

        function updateVisibility() {
            if (typeSelect.value === 'key') {
                keySection.style.display = 'block';
            } else {
                keySection.style.display = 'none';
                fieldContainer.style.display = 'none';
                fieldSelect.innerHTML = '<option value="">Сначала выберите таблицу</option>';
            }
        }
        typeSelect.addEventListener('change', updateVisibility);
        document.addEventListener('DOMContentLoaded', updateVisibility);

        tableSelect.addEventListener('change', function () {
            const tableId = this.value;
            if (!tableId) {
                fieldContainer.style.display = 'none';
                return;
            }
            fetch(`?handler=TableFields&tableId=${tableId}`)
                .then(r => r.json())
                .then(fields => {
                    fieldSelect.innerHTML = '<option value="">Выберите поле...</option>';
                    fields.forEach(f => fieldSelect.innerHTML += `<option value="${f.id}">${f.name}</option>`);
                    fieldContainer.style.display = 'block';
                });
        });
    </script>
}
